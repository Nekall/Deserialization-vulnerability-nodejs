require('dotenv').config();
const express = require("express");
const bodyParser = require("body-parser");
const app = express();
const PORT = 3030;
const serialize = require("serialize-javascript");
const { FLAG, PASSWORD } = process.env;
console.log(process.env);

app.use(express.static(__dirname));
app.use(bodyParser.urlencoded({ extended: false }));

app.get("/", (req, res) => {
    res.sendFile(__dirname + "/login.html");
  });
  
  app.post("/login", (req, res) => {
    const { username, password } = req.body;
  
    if (username === "admin" && password === PASSWORD) {
      const user = {
        username: "admin",
        role: "admin"
      };
  
      const serializedUser = serialize(user);
      res.redirect("/profile?user=" + encodeURIComponent(serializedUser));
    } else if(username === "user" && password === "password") {
      const user = {
        username: username,
        role: "default"
      };
  
      const serializedUser = serialize(user);
      res.redirect("/profile?user=" + encodeURIComponent(serializedUser));
    } else {
        res.redirect(req.get("referer"));
    }
  });
  
  app.get("/profile", (req, res) => {
    const { user } = req.query;
  
    let message;
    if (user) {
      try {
        const deserializedUser = eval('(' + user + ')');
        if (deserializedUser.role === 'admin') {
          message = `Welcome administrator - Flag : ${FLAG}`;
        } else {
          message = "Welcome user !";
        }
      } catch (error) {
        message = "/!\\ Error occurred /!\\";
      }
    } else {
      message = "/!\\ User information missing /!\\";
    }

    res.write(message);
    return res.end();
  });
  
  app.listen(PORT, () => {
    console.log(`Server is running on port ${PORT}`);
  });